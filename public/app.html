<link rel="import" href="components/polymer/polymer.html">
<link rel="import" href="components/polymerfire/firebase-auth.html">
<link rel="import" href="head-fragment.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-app">
    <template>
        <style>
            :host {
                display: block;              
                min-height: 100vh;                  
            }                        
        </style>                           

        <firebase-auth 
            id="auth" 
            user="{{user}}" 
            status-known="{{statusKnown}}"
            provider="google" 
            on-error="handleError">
        </firebase-auth>                             

        <!--always load the head fragment-->
        <head-fragment
            auth="[[auth]]">
        </head-fragment>            
                            
        <template is="dom-if" if={{!promptSignIn}}>
            <body-fragment></body-fragment>         
        </template>                   
        
        <!--todo maybe auth shouldn't load assets for popups because that is heavy-->
        <template is="dom-if" if={{promptSignIn}}>                
            <auth-fragment
                user="[[user]]"
                prompt-sign-in="[[promptSignIn]]"
                auth="[[auth]]"
                ></auth-fragment> 
        </template>                                     
    </template>
    <script>
        Polymer({
            is: 'my-app',
            properties: {
                user: {
                    type: Object
                },
                statusKnown:{
                    type: Boolean             
                },
                promptSignIn: {
                    type: Boolean,
                    computed: '_computePrompt(user, statusKnown)'
                },
                auth: {
                    type: Object
                },
                path: {
                    type: String
                }
            },            
            ready(){
                this.auth = this.$.auth;                
            },
            _computePrompt(user, statusKnown){
                const val = !user && statusKnown;    
                const that = this;
                if(val){
                    this.path = "/login/";
                    this.importHref("auth-fragment.html",(result) => {
                        that.fire("auth-init",{},{
                            node: that.$$("auth-fragment")
                        });
                    });                
                }else if(statusKnown){                    
                    that.fire("auth-init",{},{
                        node: that.$$("auth-fragment")
                    });

                    if(user) {
                        this.path = "/";
                        this.importHref("body-fragment.html",(result) => {
                            that.fire("body-init",{},{
                                node: that.$$("body-fragment")
                            });
                        });
                    }

                    this.path = "/login/";
                }  
                return val;
            },                                                
            handleError(){

            }
        });
    </script>
</dom-module>
